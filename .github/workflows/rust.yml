name: tauri-build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: {}

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  NODE_OPTIONS: "--max-old-space-size=4096"
  CACHE_VERSION: "v3"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            name: "macOS ARM64"
            platform: "macos-arm64"
            rust-cache-key: "macos-arm64"
            upload_sftp: true
            upload_github: false
          - os: macos-latest
            target: x86_64-apple-darwin
            name: "macOS x64"
            platform: "macos-x64"
            rust-cache-key: "macos-x64"
            upload_sftp: true
            upload_github: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: "Windows x64"
            platform: "windows-x64"
            rust-cache-key: "windows-x64"
            upload_sftp: true
            upload_github: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: "Linux x64"
            platform: "linux-x64"
            rust-cache-key: "linux-x64"
            upload_sftp: true
            upload_github: false
          - os: [self-hosted, ARM64, Linux]
            target: aarch64-unknown-linux-gnu
            name: "Linux ARM64"
            platform: "linux-arm64"
            rust-cache-key: "linux-arm64"
            upload_sftp: false
            upload_github: true
    
    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.name }}

    steps:
      # ========================================
      # CHECKOUT CON OTTIMIZZAZIONI
      # ========================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          show-progress: false

      # ========================================
      # CACHE INTELLIGENTE MULTI-LIVELLO
      # ========================================
      - name: Cache Rust dependencies
        if: contains(matrix.os, 'self-hosted') == false
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ env.CACHE_VERSION }}-${{ matrix.rust-cache-key }}
          cache-on-failure: true
          cache-all-crates: true
          cache-targets: true
          cache-directories: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/

      - name: Cache Node.js dependencies
        if: contains(matrix.os, 'self-hosted') == false
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            ~/.cache/npm
          key: ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-node-

      # ========================================
      # SETUP OTTIMIZZATO PER GITHUB RUNNERS
      # ========================================
      - name: Setup Node.js (GitHub hosted)
        if: contains(matrix.os, 'self-hosted') == false
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Rust (GitHub hosted)
        if: contains(matrix.os, 'self-hosted') == false
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
          components: rustfmt, clippy

      # ========================================
      # SETUP OTTIMIZZATO PER SELF-HOSTED
      # ========================================
      - name: Check environment (self-hosted)
        if: contains(matrix.os, 'self-hosted')
        id: check_env
        shell: bash
        run: |
          echo "ðŸ” Quick environment check..."
          
          ARCH=$(uname -m)
          echo "arch=$ARCH" >> $GITHUB_OUTPUT
          
          NODE_OK=false
          if command -v node >/dev/null 2>&1; then
            NODE_VERSION=$(node --version)
            if [[ "$NODE_VERSION" =~ ^v(1[8-9]|[2-9][0-9]) ]]; then
              NODE_OK=true
              echo "âœ… Node.js OK: $NODE_VERSION"
            else
              echo "âš ï¸  Node.js version $NODE_VERSION might be outdated"
            fi
          else
            echo "âŒ Node.js not found"
          fi
          echo "node_ok=$NODE_OK" >> $GITHUB_OUTPUT
          
          RUST_OK=false
          if command -v cargo >/dev/null 2>&1 && command -v rustc >/dev/null 2>&1; then
            RUST_VERSION=$(rustc --version)
            if rustup target list --installed | grep -q "${{ matrix.target }}"; then
              RUST_OK=true
              echo "âœ… Rust OK: $RUST_VERSION with target ${{ matrix.target }}"
            else
              echo "âš ï¸  Rust found but missing target ${{ matrix.target }}"
            fi
          else
            echo "âŒ Rust not found"
          fi
          echo "rust_ok=$RUST_OK" >> $GITHUB_OUTPUT
          
          TAURI_OK=false
          if command -v tauri >/dev/null 2>&1; then
            TAURI_VERSION=$(tauri --version 2>/dev/null || echo 'error')
            if [[ "$TAURI_VERSION" != "error" ]]; then
              TAURI_OK=true
              echo "âœ… Tauri CLI OK: $TAURI_VERSION"
            fi
          fi
          echo "tauri_ok=$TAURI_OK" >> $GITHUB_OUTPUT

      - name: Setup Node.js (self-hosted ARM64)
        if: contains(matrix.os, 'self-hosted')
        shell: bash
        run: |
          echo "ðŸš€ Installing Node.js via nvm for Raspberry Pi..."
          curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.6/install.sh | bash
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          nvm install 18
          nvm use 18

          echo "Node.js version: $(node -v)"
          echo "Node architecture: $(node -p 'process.arch')"
          echo "NPM version: $(npm -v)"

      - name: Setup Rust (self-hosted)
        if: contains(matrix.os, 'self-hosted') && steps.check_env.outputs.rust_ok != 'true'
        shell: bash
        run: |
          echo "ðŸ¦€ Setting up Rust..."
          if ! command -v rustup >/dev/null 2>&1; then
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
            source ~/.cargo/env
          fi
          rustup target add ${{ matrix.target }}
          echo "Rust ready: $(rustc --version)"

      - name: Setup Tauri CLI (self-hosted)
        if: contains(matrix.os, 'self-hosted') && steps.check_env.outputs.tauri_ok != 'true'
        shell: bash
        run: |
          echo "âš¡ Installing Tauri CLI..."
          source ~/.cargo/env 2>/dev/null || true
          cargo install tauri-cli --locked
          echo "Tauri CLI ready: $(tauri --version)"

      # Setup SSH key from secrets for secure upload
      - name: Setup SSH key
        if: matrix.upload_sftp == true
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Set version and build date cross-platform
      - name: Set version and build date (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Set version and build date (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = (Get-Content package.json | ConvertFrom-Json).version
          Write-Host "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          $buildDate = Get-Date -Format "yyyy-MM-dd"
          Write-Host "BUILD_DATE=$buildDate" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      
      # ========================================
      # DIPENDENZE SISTEMA OTTIMIZZATE
      # ========================================
      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            pkg-config

      - name: Install system dependencies (self-hosted)
        if: contains(matrix.os, 'self-hosted')
        shell: bash
        run: |
          MISSING_DEPS=()
          for dep in libgtk-3-dev libwebkit2gtk-4.1-dev build-essential; do
            if ! dpkg -l | grep -q "^ii  $dep "; then
              MISSING_DEPS+=("$dep")
            fi
          done
          
          if [[ ${#MISSING_DEPS[@]} -gt 0 ]]; then
            echo "ðŸ“¦ Installing missing dependencies: ${MISSING_DEPS[*]}"
            sudo apt-get update -qq
            sudo apt-get install -y --no-install-recommends \
              libgtk-3-dev \
              libwebkit2gtk-4.1-dev \
              libayatana-appindicator3-dev \
              librsvg2-dev \
              patchelf \
              build-essential \
              libssl-dev \
              pkg-config
          else
            echo "âœ… All system dependencies already installed"
          fi

      - name: Install Windows dependencies
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          choco install nsis -y --no-progress

      # ========================================
      # CONFIGURAZIONI OTTIMIZZATE
      # ========================================
      - name: Configure build environment
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            echo "RUSTFLAGS=-C target-cpu=native -C opt-level=2" >> $GITHUB_ENV
            echo "CARGO_BUILD_JOBS=$(nproc)" >> $GITHUB_ENV
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            echo "RUSTFLAGS=-C target-cpu=native" >> $GITHUB_ENV
            echo "CARGO_BUILD_JOBS=$(sysctl -n hw.logicalcpu)" >> $GITHUB_ENV
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            echo "RUSTFLAGS=-C target-cpu=native" >> $env:GITHUB_ENV
            echo "CARGO_BUILD_JOBS=$env:NUMBER_OF_PROCESSORS" >> $env:GITHUB_ENV
          fi

      - name: Configure Cargo (advanced)
        shell: bash
        run: |
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << 'EOF'
          [build]
          
          [net]
          retry = 2
          git-fetch-with-cli = true
          
          [profile.dev]
          opt-level = 1
          debug = 1
          incremental = true
          
          [profile.release]
          opt-level = 3
          lto = "thin"
          codegen-units = 1
          panic = "abort"
          
          [profile.release-with-debug]
          inherits = "release"
          debug = true
          EOF

      # ========================================
      # BUILD FRONTEND (OTTIMIZZATO)
      # ========================================
      - name: Install frontend dependencies (self-hosted ARM64)
        if: contains(matrix.os, 'self-hosted')
        shell: bash
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          nvm use 18
          echo "ðŸ§¹ Cleaning previous Node modules and cache..."
          rm -rf node_modules package-lock.json
          npm cache clean --force
          
          echo "ðŸ“¦ Installing Node.js dependencies for ARM64 (build from source)..."
          npm install --build-from-source --prefer-offline --no-audit --no-fund

      - name: Build frontend (self-hosted ARM64)
        if: contains(matrix.os, 'self-hosted')
        shell: bash
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          nvm use 18
          echo "ðŸŽ¨ Building frontend for ARM64..."
          export NODE_OPTIONS="--max-old-space-size=4096"
          if [[ "$(nproc)" -gt 2 ]]; then
            export UV_THREADPOOL_SIZE=$(nproc)
          fi
          npm run build

      - name: Install frontend dependencies
        if: contains(matrix.os, 'self-hosted') == false
        shell: bash
        run: |
          if [[ -f "package-lock.json" ]]; then
            npm ci --prefer-offline --no-audit --no-fund
          else
            npm install --prefer-offline --no-audit --no-fund
          fi

      - name: Build frontend
        if: contains(matrix.os, 'self-hosted') == false
        shell: bash
        run: |
          echo "ðŸŽ¨ Building frontend..."
          export NODE_OPTIONS="--max-old-space-size=4096"
          if [[ "${{ runner.os }}" == "Linux" ]] && [[ "$(nproc)" -gt 2 ]]; then
            export UV_THREADPOOL_SIZE=$(nproc)
          fi
          npm run build

      # ========================================
      # BUILD TAURI (SUPER OTTIMIZZATO)
      # ========================================
      - name: Build Tauri application
        shell: bash
        run: |
          echo "ðŸš€ Building Tauri app for ${{ matrix.name }}..."
          
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            export PKG_CONFIG_ALLOW_CROSS=1
            export CARGO_TARGET_DIR="target"
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            export CARGO_TARGET_DIR="target"
            export RUSTFLAGS="$RUSTFLAGS -C link-arg=/INCREMENTAL:NO"
          fi
          
          if [[ "${{ contains(matrix.os, 'self-hosted') }}" == "true" ]]; then
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 18
            source ~/.cargo/env 2>/dev/null || true
            tauri build --target ${{ matrix.target }} --verbose
          else
            npm run tauri build -- --target ${{ matrix.target }}
          fi

      # ========================================
      # PREPARAZIONE ARTIFACTS PER SFTP
      # ========================================
      - name: Prepare artifacts for SFTP upload
        if: matrix.upload_sftp == true
        shell: bash
        run: |
          echo "ðŸ“¦ Preparing artifacts structure for SFTP..."
          
          # Crea la struttura: artifacts/{version}/{build_date}/{platform}/
          UPLOAD_DIR="artifacts/${{ env.VERSION }}/${{ env.BUILD_DATE }}/${{ matrix.platform }}"
          mkdir -p "$UPLOAD_DIR"
          
          # Copia i file in base alla piattaforma
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            echo "Collecting Windows artifacts..."
            find src-tauri/target -name "*.exe" -type f -exec cp {} "$UPLOAD_DIR/" \; 2>/dev/null || true
            
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            echo "Collecting macOS artifacts..."
            find src-tauri/target -name "*.dmg" -type f -exec cp {} "$UPLOAD_DIR/" \; 2>/dev/null || true
            # Comprimi .app in zip
            for app in src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app; do
              if [[ -d "$app" ]]; then
                APP_NAME=$(basename "$app")
                (cd "$(dirname "$app")" && zip -r -q "$UPLOAD_DIR/${APP_NAME}.zip" "$APP_NAME")
              fi
            done
            
          else
            echo "Collecting Linux artifacts..."
            find src-tauri/target -name "*.deb" -type f -exec cp {} "$UPLOAD_DIR/" \; 2>/dev/null || true
            find src-tauri/target -name "*.AppImage" -type f -exec cp {} "$UPLOAD_DIR/" \; 2>/dev/null || true
          fi
          
          # Verifica che ci siano file
          if [[ -z "$(ls -A "$UPLOAD_DIR")" ]]; then
            echo "âš ï¸ Warning: No artifacts found for upload!"
            exit 0
          fi
          
          # Crea manifest con info build
          cat > "$UPLOAD_DIR/build-info.json" << EOF
          {
            "version": "${{ env.VERSION }}",
            "build_date": "${{ env.BUILD_DATE }}",
            "platform": "${{ matrix.platform }}",
            "target": "${{ matrix.target }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "workflow_run": "${{ github.run_number }}"
          }
          EOF
          
          echo "âœ… Artifacts prepared in: $UPLOAD_DIR"
          ls -lh "$UPLOAD_DIR"

      # ========================================
      # UPLOAD VIA SFTP
      # ========================================
      - name: Upload artifacts to server via SFTP
        if: matrix.upload_sftp == true
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          username: ${{ secrets.SFTP_USERNAME }}
          server: ${{ secrets.SFTP_HOST }}
          port: ${{ secrets.SFTP_PORT || 22 }}
          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          local_path: ./artifacts/*
          remote_path: ${{ secrets.SFTP_REMOTE_PATH }}/artifacts
          delete_remote_files: false
          sftp_only: true

      # ========================================
      # UPLOAD ARTIFACTS GITHUB (ORGANIZZATO E SENZA STRUTTURA)
      # ========================================
      - name: Prepare Windows artifact files
        if: matrix.upload_github == true && matrix.os == 'windows-latest'
        shell: bash
        run: |
          mkdir -p artifact_files/windows
          cp src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe artifact_files/windows/ || true
          cp src-tauri/target/release/bundle/nsis/*.exe artifact_files/windows/ || true

      - name: Upload Windows artifacts
        if: matrix.upload_github == true && matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: AirShare-${{ matrix.name }}-Setup
          path: artifact_files/windows/*.exe
          if-no-files-found: warn
          retention-days: 30

      - name: Prepare macOS artifact files
        if: matrix.upload_github == true && matrix.os == 'macos-latest'
        shell: bash
        run: |
          mkdir -p artifact_files/macos
          cp src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg artifact_files/macos/ || true
          cp -r src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app artifact_files/macos/ || true

      - name: Upload macOS artifacts
        if: matrix.upload_github == true && matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: AirShare-${{ matrix.name }}
          path: artifact_files/macos/*
          if-no-files-found: warn
          retention-days: 30

      - name: Prepare Linux artifact files
        if: matrix.upload_github == true && (matrix.os == 'ubuntu-latest' || contains(matrix.os, 'self-hosted'))
        shell: bash
        run: |
          mkdir -p artifact_files/linux
          cp src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb artifact_files/linux/ || true
          cp src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage artifact_files/linux/ || true
          cp src-tauri/target/release/bundle/deb/*.deb artifact_files/linux/ || true
          cp src-tauri/target/release/bundle/appimage/*.AppImage artifact_files/linux/ || true

      - name: Upload Linux artifacts
        if: matrix.upload_github == true && (matrix.os == 'ubuntu-latest' || contains(matrix.os, 'self-hosted'))
        uses: actions/upload-artifact@v4
        with:
          name: AirShare-${{ matrix.name }}
          path: artifact_files/linux/*
          if-no-files-found: warn
          retention-days: 30

      # ========================================
      # CLEANUP E OTTIMIZZAZIONE POST-BUILD
      # ========================================
      - name: Cleanup build artifacts
        if: always()
        shell: bash
        run: |
          if [[ "${{ runner.os }}" != "Windows" ]]; then
            find . -name "*.tmp" -type f -delete 2>/dev/null || true
            find . -name "*.temp" -type f -delete 2>/dev/null || true
          fi
          
          if command -v du >/dev/null 2>&1; then
            echo "ðŸ“Š Final target directory size:"
            du -sh src-tauri/target/ 2>/dev/null || echo "Target directory not found"
          fi